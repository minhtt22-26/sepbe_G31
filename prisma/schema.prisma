// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client"
  previewFeatures = ["postgresqlExtensions"]
  output          = "../src/generated/prisma"
  moduleFormat    = "cjs"
}

datasource db {
  provider   = "postgresql"
  extensions = [pgvector(map: "vector")]
}

// =====================
// ENUMS
// =====================

enum CompanyStatus {
  PENDING // Chờ duyệt
  APPROVED // Đã duyệt
  REJECTED // Bị từ chối
  DELETED
}

enum EnumUserGender {
  MALE
  FEMALE
  OTHER
}

enum EnumUserRole {
  WORKER
  EMPLOYER
  ADMIN
  MANAGER
}

enum EnumUserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
  DELETED
}

enum EnumUserLoginWith {
  CREDENTIAL
  SOCIAL_GOOGLE
}

enum EnumShift {
  MORNING
  AFTERNOON
  NIGHT
  FULL_DAY
  FLEXIBLE
}

enum SectorStatus {
  ACTIVE
  DELETED
}

enum JobStatus {
  WARNING // tạo nhưng chưa public
  PUBLISHED // đang tuyển, worker thấy & apply được
  EXPIRED // hết hạn tự động
  DELETED
}

enum JobApplicationStatus {
  APPLIED // worker vừa nộp hồ sơ
  VIEWED // employer đã xem
  SUITABLE // mời phỏng vấn / test
  UNSUITABLE // bị từ chối
  CANCELLED // worker tự rút hồ sơ
}

enum ReportReason {
  FRAUD
  INAPPROPRIATE_CONTENT
  SCAM
  DUPLICATE
  MISLEADING_INFO
  OTHER
}

enum ReportStatus {
  PENDING
  RESOLVED
  REJECTED
}

enum ReviewStatus {
  ACTIVE
  DELETED
}

enum TokenType {
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  MOMO
  VNPAY
  ZALOPAY
  BANK_TRANSFER
  CREDIT_CARD
  SEPAY
}

enum OrderType {
  BOOST_JOB
  PREMIUM_SUBSCRIPTION
  FEATURE_LISTING
}

// =====================
// USER & AUTH
// =====================

model User {
  id              Int                @id @default(autoincrement())
  avatar          String?
  fullName        String
  userName        String?            @unique
  phone           String             @unique
  role            EnumUserRole
  status          EnumUserStatus     @default(ACTIVE)
  email           String?            @unique
  password        String?
  loginWith       EnumUserLoginWith?
  passwordExpired DateTime?
  passwordCreated DateTime?
  passwordAttempt Int                @default(0)
  isVerified      Boolean            @default(false)
  verifiedAt      DateTime?
  lastLoginAt     DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relations
  workerProfile WorkerProfile?

  // User activities
  applications       JobApplication[]
  savedJobs          SavedJob[]
  companyReviews     CompanyReview[]
  sessions           Session[]
  verificationTokens VerificationToken[]
  paymentOrders      PaymentOrder[]
  companies          Company[]             @relation("CompanyOwner")
  reportedJobs       JobReport[]           @relation("JobReporter")
  reportedReviews    CompanyReviewReport[] @relation("ReviewReporter")
  notifications      Notification[]

  @@index([email])
  @@index([role])
  @@index([status])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String
  message   String?
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Session {
  id        String    @id
  userId    Int
  jti       String    @unique
  ipAddress String?
  userAgent String?
  isRevoked Boolean?
  expiredAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiredAt])
}

model VerificationToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  token     String    @unique
  type      TokenType
  expiredAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiredAt])
}

model WorkerProfile {
  id     Int @id @default(autoincrement())
  userId Int @unique

  occupationId Int?

  address  String?
  province String?
  district String?

  gender            EnumUserGender?
  birthYear         Int?
  expectedSalaryMin Int?
  expectedSalaryMax Int?
  experienceYear    Int?

  // AI Embeddings for job matching (pgvector)
  profileEmbedding   Unsupported("vector(768)")?
  embeddingUpdatedAt DateTime?

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  occupation Occupation? @relation(fields: [occupationId], references: [id])
  sector     Sector?     @relation(fields: [sectorId], references: [id])
  sectorId   Int?
}

// =====================
// COMPANY
// =====================

model Company {
  id                 Int             @id @default(autoincrement())
  ownerId            Int
  name               String
  taxCode            String?         @unique
  address            String?
  description        String?
  website            String?
  logoUrl            String?
  businessLicenseUrl String?
  // Approval flow
  status             CompanyStatus   @default(PENDING)
  rejectionReason    String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  owner              User            @relation("CompanyOwner", fields: [ownerId], references: [id])
  jobs               Job[]
  reviews            CompanyReview[]

  @@index([ownerId])
  @@index([status])
}

model CompanyReview {
  id                Int          @id @default(autoincrement())
  companyId         Int
  userId            Int
  rating            Int // Overall rating (1-5)
  title             String?
  content           String?
  salaryRating      Int? // 1-5
  environmentRating Int? // 1-5
  overtimeRating    Int? // 1-5
  managementRating  Int? // 1-5
  isAnonymous       Boolean      @default(false)
  status            ReviewStatus @default(ACTIVE)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  company Company               @relation(fields: [companyId], references: [id])
  user    User                  @relation(fields: [userId], references: [id])
  reports CompanyReviewReport[]

  @@unique([companyId, userId])
  @@index([companyId])
  @@index([userId])
}

model CompanyReviewReport {
  id          Int          @id @default(autoincrement())
  reviewId    Int
  reporterId  Int
  reason      ReportReason
  description String?
  status      ReportStatus @default(PENDING)
  managerNote String?
  createdAt   DateTime     @default(now())

  review   CompanyReview @relation(fields: [reviewId], references: [id])
  reporter User          @relation("ReviewReporter", fields: [reporterId], references: [id])

  @@unique([reviewId, reporterId])
  @@index([reviewId])
  @@index([reporterId])
  @@index([status])
}

// =====================
// JOBS
// =====================

model Sector {
  id        Int          @id @default(autoincrement())
  name      String       @unique
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  status    SectorStatus @default(ACTIVE)

  occupations Occupation[]
  workers     WorkerProfile[]
}

model Occupation {
  id        Int          @id @default(autoincrement())
  sectorId  Int
  name      String // Công nhân lắp ráp, Công nhân may, Đứng máy ép nhựa
  status    SectorStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  sector  Sector          @relation(fields: [sectorId], references: [id])
  jobs    Job[]
  workers WorkerProfile[]

  @@index([sectorId])
}

model Job {
  id        Int @id @default(autoincrement())
  companyId Int

  occupationId Int

  title             String
  description       String
  status            JobStatus
  address           String?
  province          String?
  district          String?
  salaryMin         Int?
  salaryMax         Int?
  workingShift      EnumShift
  quantity          Int
  genderRequirement EnumUserGender?
  ageMin            Int?
  ageMax            Int?
  expiredAt         DateTime?

  // Boost information
  isBoosted      Boolean   @default(false)
  boostExpiredAt DateTime?

  // AI Fields (pgvector)
  jobEmbedding       Unsupported("vector(768)")?
  embeddingUpdatedAt DateTime?
  fraudScore         Float                       @default(0)
  fraudCheckedAt     DateTime?
  isFlagged          Boolean                     @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company    Company    @relation(fields: [companyId], references: [id])
  occupation Occupation @relation(fields: [occupationId], references: [id])

  applications JobApplication[]
  savedBy      SavedJob[]
  applyForms   JobApplyForm[]
  reports      JobReport[]

  @@index([companyId])
  @@index([occupationId])
  @@index([status])
  @@index([province])
  @@index([district])
  @@index([isBoosted])
}

model JobReport {
  id          Int          @id @default(autoincrement())
  jobId       Int
  reporterId  Int
  reason      ReportReason
  description String?
  status      ReportStatus @default(PENDING)
  managerNote String?
  createdAt   DateTime     @default(now())

  job      Job  @relation(fields: [jobId], references: [id])
  reporter User @relation("JobReporter", fields: [reporterId], references: [id])

  @@unique([jobId, reporterId])
  @@index([jobId])
  @@index([reporterId])
  @@index([status])
}

model SavedJob {
  id        Int      @id @default(autoincrement())
  userId    Int
  jobId     Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId])
}

model JobApplication {
  id        Int                  @id @default(autoincrement())
  jobId     Int
  userId    Int
  status    JobApplicationStatus @default(APPLIED)
  updatedAt DateTime             @updatedAt

  job     Job                    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user    User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers JobApplicationAnswer[]

  @@unique([jobId, userId])
  @@index([jobId])
  @@index([status])
}

// =====================
// APPLY FORMS
// =====================

model JobApplyForm {
  id        Int      @id @default(autoincrement())
  jobId     Int
  createdAt DateTime @default(now())

  job    Job                 @relation(fields: [jobId], references: [id], onDelete: Cascade)
  fields JobApplyFormField[]

  @@index([jobId])
}

model JobApplyFormField {
  id         Int     @id @default(autoincrement())
  formId     Int
  label      String
  fieldType  String // e.g., "text", "textarea", "select", "radio", "checkbox"
  isRequired Boolean @default(false)
  options    String? // JSON string for select/radio/checkbox options

  form    JobApplyForm           @relation(fields: [formId], references: [id], onDelete: Cascade)
  answers JobApplicationAnswer[]

  @@index([formId])
}

model JobApplicationAnswer {
  id               Int    @id @default(autoincrement())
  jobApplicationId Int
  fieldId          Int
  value            String

  application JobApplication    @relation(fields: [jobApplicationId], references: [id], onDelete: Cascade)
  field       JobApplyFormField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@index([jobApplicationId])
  @@index([fieldId])
}

// =====================
// PAYMENTS & TERMS
// =====================

model PaymentOrder {
  id              Int           @id @default(autoincrement())
  userId          Int
  orderType       OrderType
  targetId        Int? // ID of job being boosted, etc.
  amount          Int
  currency        String        @default("VND")
  status          PaymentStatus @default(PENDING)
  paymentMethod   PaymentMethod
  transactionCode String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([orderType])
  @@index([createdAt])
}

model TermsConditions {
  id          Int      @id @default(autoincrement())
  title       String
  content     String
  effectiveAt DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([effectiveAt])
}
