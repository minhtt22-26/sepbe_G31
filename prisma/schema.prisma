// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client"
  previewFeatures = ["postgresqlExtensions"]
  output          = "../src/generated/prisma"
  moduleFormat    = "cjs"
}

datasource db {
  provider   = "postgresql"
  extensions = [pgvector(map: "vector")]
}

// =====================
// ENUMS
// =====================

enum CompanyStatus {
  PENDING // Chờ duyệt
  APPROVED // Đã duyệt
  REJECTED // Bị từ chối
  DELETED      
  NEED_MORE_INFO
}

enum EnumUserGender {
  MALE
  FEMALE
  OTHER
}

enum EnumUserRole {
  WORKER
  EMPLOYER
  ADMIN
  MANAGER
}

enum EnumUserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
  DELETED      
}

enum EnumUserLoginWith {
  CREDENTIAL
  SOCIAL_GOOGLE
}

enum EnumShift {
  MORNING
  AFTERNOON
  NIGHT
}

enum JobStatus {
  DRAFT // tạo nhưng chưa public
  PUBLISHED // đang tuyển, worker thấy & apply được
  PAUSED // tạm dừng (đủ người, chờ xử lý)
  CLOSED // tuyển xong / ngừng hẳn
  EXPIRED // hết hạn tự động
  DELETED      
}

enum JobApplicationStatus {
  APPLIED // worker vừa nộp hồ sơ
  VIEWED // employer đã xem
  INTERVIEW // mời phỏng vấn / test
  REJECTED // bị từ chối
  CANCELLED // worker tự rút hồ sơ
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  REJECTED
}

enum ReportReason {
  FRAUD
  INAPPROPRIATE_CONTENT
  SCAM
  DUPLICATE
  MISLEADING_INFO
  OTHER
}

enum ReviewReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  REJECTED
}

enum ReviewStatus {
  ACTIVE      
  HIDDEN   
  DELETED         
}

enum TokenType {
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  MOMO
  VNPAY
  ZALOPAY
  BANK_TRANSFER
  CREDIT_CARD
}

enum OrderType {
  BOOST_JOB
  PREMIUM_SUBSCRIPTION
  FEATURE_LISTING
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
  OTHER
}

enum EnumBenefit {
  DORMITORY          // Có chỗ ở / Ký túc xá
  TRANSPORTATION     // Có xe đưa đón
  MEAL_ALLOWANCE     // Phụ cấp cơm trưa / Bao ăn
  INSURANCE_FULL     // Đóng BHXH đầy đủ
  ATTENDANCE_BONUS   // Thưởng chuyên cần
  THIRTEENTH_SALARY  // Lương tháng 13
  UNIFORM_PROVIDED   // Cấp phát đồng phục
  TRAVEL_TRIP        // Du lịch hàng năm
  TRAINING           // Được đào tạo nghề
}

// =====================
// USER & AUTH
// =====================

model User {
  id              Int            @id @default(autoincrement())
  avatar          String?
  fullName        String
  userName        String?         @unique
  phone           String?
  role            EnumUserRole
  status          EnumUserStatus @default(ACTIVE)
  email           String?        @unique
  password        String?
  loginWith       EnumUserLoginWith?
  passwordExpired DateTime?
  passwordCreated DateTime?
  passwordAttempt Int            @default(0)
  isVerified      Boolean        @default(false)
  verifiedAt      DateTime?
  lastLoginAt     DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  workerProfile WorkerProfile?

  // User activities
  jobs                         Job[]                 @relation("JobCreator")
  applications                 JobApplication[]
  savedJobs                    SavedJob[]
  companyReviews               CompanyReview[]
  sessions                     Session[]
  verificationTokens           VerificationToken[]
  paymentOrders                PaymentOrder[]
  companies                    Company[]             @relation("CompanyOwner")
  reviewedCompanies            Company[]             @relation("CompanyReviewer")
  reportedJobs                 JobReport[]           @relation("JobReporter")
  reviewedJobReports           JobReport[]           @relation("JobReportReviewer")
  reportedReviews    CompanyReviewReport[] @relation("ReviewReporter")

  @@index([email])
  @@index([role])
  @@index([status])
}

model Session {
  id        String       @id 
  userId    Int
  jti       String    @unique
  ipAddress String?
  userAgent String?
  expiredAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiredAt])
}

model VerificationToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  token     String    @unique
  type      TokenType
  expiredAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiredAt])
}

model WorkerProfile {
  id                    Int             @id @default(autoincrement())
  userId                Int             @unique

  sectorId              Int?
  occupationId          Int?

  address               String?
  province              String?
  district              String?

  shift                 EnumShift[]
  gender                EnumUserGender?
  birthYear             Int?
  expectedSalaryMin        Int?
  expectedSalaryMax        Int?
  experienceYear        Int?
  desiredBenefits       EnumBenefit[]

  // AI Embeddings for job matching (pgvector)
  profileEmbedding   Unsupported("vector(768)")?
  embeddingUpdatedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  sector       Sector?     @relation(fields: [sectorId], references: [id])
  occupation   Occupation? @relation(fields: [occupationId], references: [id])  

  @@index([shift])
  @@index([province])
  @@index([district])
  @@index([expectedSalaryMin])
  @@index([expectedSalaryMax])
}

// =====================
// COMPANY
// =====================

model Company {
  id              Int     @id @default(autoincrement())
  ownerId         Int
  name            String
  taxCode         String? @unique
  address         String?
  description     String?
  website         String?
  logo            String?
  coverImage      String?
  businessLicense String? // Giấy phép kinh doanh

  // Approval flow
  status          CompanyStatus @default(PENDING)
  reviewedBy      Int?
  reviewedAt      DateTime?
  reviewNotes     String?
  rejectionReason String?

  isVerified Boolean         @default(false)
  verifiedAt DateTime?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  owner      User            @relation("CompanyOwner", fields: [ownerId], references: [id])
  reviewer   User?           @relation("CompanyReviewer", fields: [reviewedBy], references: [id])
  jobs       Job[]
  reviews    CompanyReview[]

  @@index([ownerId])
  @@index([status])
  @@index([isVerified])
}

model CompanyReview {
  id                Int          @id @default(autoincrement())
  companyId         Int
  userId            Int
  rating            Int // Overall rating (1-5)
  title             String?
  content           String?
  salaryRating      Int? // 1-5
  environmentRating Int? // 1-5
  overtimeRating    Int? // 1-5
  managementRating  Int? // 1-5
  isAnonymous       Boolean      @default(false)
  status            ReviewStatus @default(ACTIVE)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  company Company               @relation(fields: [companyId], references: [id])
  user    User                  @relation(fields: [userId], references: [id])
  reports CompanyReviewReport[]

  @@unique([companyId, userId])
  @@index([companyId])
  @@index([userId])
  @@index([status])
}

model CompanyReviewReport {
  id          Int                @id @default(autoincrement())
  reviewId    Int
  reporterId  Int
  reason      ReportReason
  description String?
  status      ReviewReportStatus @default(PENDING)
  reviewedAt  DateTime?
  resolution  String?
  createdAt   DateTime           @default(now())

  review   CompanyReview @relation(fields: [reviewId], references: [id])
  reporter User          @relation("ReviewReporter", fields: [reporterId], references: [id])

  @@unique([reviewId, reporterId])
  @@index([reviewId])
  @@index([reporterId])
  @@index([status])
}

// =====================
// JOBS
// =====================

model Sector {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  deletedAt DateTime?
  deletedBy Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  jobs Job[]
  occupations Occupation[]
  workers     WorkerProfile[]

  @@index([deletedAt])
}

model Occupation {
  id        Int    @id @default(autoincrement())
  sectorId  Int
  name      String // Công nhân lắp ráp, Công nhân may, Đứng máy ép nhựa
  deletedAt DateTime?
  deletedBy Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  sector    Sector @relation(fields: [sectorId], references: [id])
  jobs      Job[]
  workers   WorkerProfile[]

  @@index([sectorId])
}

model Job {
  id                Int        @id @default(autoincrement())
  companyId         Int
  sectorId          Int
  creatorId         Int

  occupationId      Int

  title             String
  description       String
  status            JobStatus
  address           String?
  province          String?
  district          String?
  salaryMin         Int?
  salaryMax         Int?
  workingShift      EnumShift[]
  quantity          Int
  genderRequirement EnumUserGender?
  ageMin            Int?
  ageMax            Int?
  expiredAt         DateTime?
  viewCount         Int        @default(0)
  benefits          EnumBenefit[]

  // Boost information
  isBoosted      Boolean   @default(false)
  boostExpiredAt DateTime?
  boostStartedAt DateTime?

  // AI Fields (pgvector)
  jobEmbedding       Unsupported("vector(768)")?
  embeddingUpdatedAt DateTime?
  fraudScore         Float                       @default(0)
  fraudCheckedAt     DateTime?
  isFlagged          Boolean                     @default(false)

  // Soft delete
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  company      Company          @relation(fields: [companyId], references: [id])
  sector       Sector           @relation(fields: [sectorId], references: [id])
  creator      User             @relation("JobCreator", fields: [creatorId], references: [id])
  occupation   Occupation       @relation(fields: [occupationId], references: [id])
  
  applications JobApplication[]
  savedBy      SavedJob[]
  applyForms   JobApplyForm[]
  reports      JobReport[]

  @@index([companyId])
  @@index([sectorId])
  @@index([occupationId])
  @@index([creatorId])
  @@index([status])
  @@index([province])
  @@index([district])
  @@index([isBoosted])
  @@index([expiredAt])
  @@index([createdAt])
}

model JobReport {
  id          Int          @id @default(autoincrement())
  jobId       Int
  reporterId  Int
  reason      ReportReason
  description String?
  status      ReportStatus @default(PENDING)
  reviewedBy  Int?
  reviewedAt  DateTime?
  resolution  String?
  createdAt   DateTime     @default(now())

  job      Job   @relation(fields: [jobId], references: [id])
  reporter User  @relation("JobReporter", fields: [reporterId], references: [id])
  reviewer User? @relation("JobReportReviewer", fields: [reviewedBy], references: [id])

  @@unique([jobId, reporterId])
  @@index([jobId])
  @@index([reporterId])
  @@index([status])
}

model SavedJob {
  id        Int      @id @default(autoincrement())
  userId    Int
  jobId     Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId])
}

model JobApplication {
  id        Int                  @id @default(autoincrement())
  jobId     Int
  userId    Int
  status    JobApplicationStatus @default(APPLIED)
  appliedAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  job     Job                    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user    User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers JobApplicationAnswer[]

  @@unique([jobId, userId])
  @@index([userId])
  @@index([jobId])
  @@index([status])
  @@index([appliedAt])
}

// =====================
// APPLY FORMS
// =====================

model JobApplyForm {
  id        Int      @id @default(autoincrement())
  jobId     Int
  createdAt DateTime @default(now())

  job    Job                 @relation(fields: [jobId], references: [id], onDelete: Cascade)
  fields JobApplyFormField[]

  @@index([jobId])
}

model JobApplyFormField {
  id         Int     @id @default(autoincrement())
  formId     Int
  label      String
  fieldType  String // e.g., "text", "textarea", "select", "radio", "checkbox"
  isRequired Boolean @default(false)
  options    String? // JSON string for select/radio/checkbox options

  form    JobApplyForm           @relation(fields: [formId], references: [id], onDelete: Cascade)
  answers JobApplicationAnswer[]

  @@index([formId])
}

model JobApplicationAnswer {
  id               Int    @id @default(autoincrement())
  jobApplicationId Int
  fieldId          Int
  value            String

  application JobApplication    @relation(fields: [jobApplicationId], references: [id], onDelete: Cascade)
  field       JobApplyFormField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@index([jobApplicationId])
  @@index([fieldId])
}

// =====================
// PAYMENTS & TERMS
// =====================

model PaymentOrder {
  id              Int           @id @default(autoincrement())
  userId          Int
  orderType       OrderType
  targetId        Int? // ID of job being boosted, etc.
  amount          Int
  currency        String        @default("VND")
  status          PaymentStatus @default(PENDING)
  paymentMethod   PaymentMethod
  transactionCode String?
  createdAt       DateTime      @default(now())
  paidAt          DateTime?
  updatedAt       DateTime      @updatedAt

  user        User  @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([orderType])
  @@index([createdAt])
}

model TermsConditions {
  id          Int            @id @default(autoincrement())
  title       String
  targetRole  EnumUserRole[]
  content     String
  effectiveAt DateTime
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([targetRole])
  @@index([effectiveAt])
}

model Media {
  id          Int       @id @default(autoincrement())
  ownerType   String    
  ownerId     Int
  url         String
  mediaType   MediaType 
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([ownerType, ownerId]) 
  @@index([mediaType])
}